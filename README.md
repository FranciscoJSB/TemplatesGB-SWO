# IaC Medical translation - PreProd Environment

[[_TOC_]]

## Status Badge

[![Build Status](https://geoblue.visualstudio.com/Digital%20Technology%20Upgrades/_apis/build/status%2FAzure.DocumentTranslation.Bicep?branchName=develop)](https://geoblue.visualstudio.com/Digital%20Technology%20Upgrades/_build/latest?definitionId=27&branchName=develop)

## Purpose

> Create infrastructure based on information available in TAD, ED, NSM, SIN and so on, documents that describe the infrastructure for the current project.

## Environments

| **Env** | **Status**                      |
| ------- | ------------------------------- |
| Dev     | Deployed     |
| PreProd | Deployed     |
| Prd     | Not deployed |

>

## Contacts

> SWO Focal Consultant | Francisco Solano - Francisco.Solano2@softwareone.com OR Francisco.solano@geo-blue.com

## Agents used

-   [Pre-Prod-builagent](https://geoblue.visualstudio.com/Digital%20Technology%20Upgrades/_settings/agentqueues?agentId=21&queueId=662&view=jobs)

## Considerations

#### About Templates

-   Don't make changes to infrastructure directly.
-   Use separate parameters files for each environment.
-   The infrastructure deployed was made using information available in the Dev environment, these must be replicated in the current scripts.

#### About Pipeline

-   The pipeline doesn't trigger for each change, this should be released manually, and correctly approved for PRD environments.

## Further considerations

-   To do a fresh deployment enable the following parameter under the main.bicep file [param isInitialDeployment bool = false], this value its intended to be set in false to do incremental deployments as this specific AI resource which  uses it, will fail if tried to be modified.

-   To enable the deployment of an agent or VM into the environment enable this parameter under the main.bicep file [param deployAgent bool = false]. Currently the deployment of Public Ip and VM are disabled.

-   Inside of the Modules>>KeyVault.bicep remove the section highlited by comments once the Agent and Pipelines have been tested.

-   The secrets used by the AI resources are generated by a randomizer in Powershell, the value is unknown as it is directly stored in the Key Vault, and a Policy is required to retrieve it. The agent's objectId should be obtained and passed in the parameters file to be able to get these secrets during deployment time.

-   Warnings will be present during validation and deployment, they are safe to be ignored.

##  CLI Commands for deployment and validation

## Deployment - PreProd

-   az deployment sub create --location eastus --template-file Infrastructure/main.bicep --parameters environments/Pre-Production/parameters-pre.json

## Validation - PreProd

-  az deployment sub validate --location eastus --template-file Infrastructure/main.bicep --parameters environments/Pre-Production/parameters-pre.json
 
## Deployment - Production

-   az deployment sub create --location eastus --template-file Infrastructure/main.bicep --parameters environments/Production/parameters-prd.json

## Validation - Production

-  az deployment sub validate --location eastus --template-file Infrastructure/main.bicep --parameters environments/Production/parameters-prd.json